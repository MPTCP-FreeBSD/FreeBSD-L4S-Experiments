# Flush all existing rules
flr all

# Enable IP forwarding
ipfw add 1000 pass all from any to any via lo0

# Allow established and related connections
ipfw add 2000 pass all from any to any via em0
ipfw add 2001 pass all from any to any via em1
ipfw add 2002 pass all from any to any via em2
ipfw add 2003 pass all from any to any via em3

# NAT configuration (assuming em0 is the internal network, and em3 is the external interface)
ipfw add 3000 nat 1 all from 192.168.1.0/24 to any out via em0
ipfw add 3001 nat 1 all from 192.168.3.0/24 to any out via em2
ipfw add 3002 nat 1 all from 192.168.5.0/24 to any out via em3

# Allow traffic from internal networks to external network (server)
ipfw add 4000 pass all from 192.168.1.0/24 to 192.168.5.0/24 via em1
ipfw add 4001 pass all from 192.168.3.0/24 to 192.168.5.0/24 via em2

# Allow traffic from external network (server) to internal networks
ipfw add 4002 pass all from 192.168.5.0/24 to 192.168.1.0/24 via em3
ipfw add 4003 pass all from 192.168.5.0/24 to 192.168.3.0/24 via em3

# Deny all other traffic
ipfw add 65535 deny all from any to any
